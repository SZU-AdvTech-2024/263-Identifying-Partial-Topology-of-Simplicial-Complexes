clc;
clear;
close all;
global A1 A2_1 A2_2 L m1 m2 d theta o1 o2;
m1=50;m2=0.01;d=1;
theta=1;
o1=0.1;o2=0.1;
A1=[0 1 1 1 1 1 1 1 1 0 1 1 1 1 0 0 0 1 0 1 0 1 0 0 0 0 0 0 0 0 0 1 0 0;
    1 0 1 1 0 0 0 1 0 0 0 0 0 1 0 0 0 1 0 1 0 1 0 0 0 0 0 0 0 0 1 0 0 0;
    1 1 0 1 0 0 0 1 1 1 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 0 0 1 0;
    1 1 1 0 0 0 0 1 0 0 0 0 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
    1 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
    1 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
    1 0 0 0 1 1 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
    1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
    1 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 1 1;
    0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1;
    1 0 0 0 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
    1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
    1 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
    1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1;
    0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1;
    0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1;
    0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
    1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
    0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1;
    1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1;
    0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1;
    1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0;
    0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1;
    0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 1 0 1 0 0 1 1;
    0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 1 0 0;
    0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 1 0 0;
    0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1;
    0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 1;
    0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 1;
    0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 1 0 0 0 0 0 1 1;
    0 1 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1;
    1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 0 1 0 0 0 1 1;
    0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 1 0 0 1 0 1 0 1 1 0 0 0 0 0 1 1 1 0 1;
    0 0 0 0 0 0 0 0 1 1 0 0 0 1 1 1 0 0 1 1 1 0 1 1 0 0 1 1 1 1 1 1 1 0;
    ];
L=length(A1);
L=22;
for i=1:L
    num=0;
    for j=1:L
        if A1(i,j)==1
            num=num+1;
        end
    end
    A1(i,i)=-num;
end
%添加2-单纯形
i1=[1 2 2 2 2 3 3 3 4 4 8 13 18 20 22 ];
j1=[1 3 18 20 22 2 4 8 3 13 3 4 2 2 2 ];
k1=[-14 1 1 1 1 1 1 1 1 1 1 1 1 1 1 ];
i2=[2 1 1 1 1 3 3 3 3 4 4 8 8 14 18 20 22 ];
j2=[2 3 18 20 22 1 4 8 14 3 8 3 4 3 1 1 1 ];
k2=[-16 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 ];
A2_1=sparse(i1,j1,k1);
A2_2=sparse(i2,j2,k2);

%添加初始值
x=zeros(L,3);
for i=1:L
    x(i,:)=[3*i-2,3*i-1,3*i];
end
x=x';
x=x(:);
y=zeros(2,3);
for i=2
    y=[3*i+28,3*i+29,3*i+30];
end
y=y';
y=y(:);
k=zeros(1,1);
a1=zeros(L,1);
a22=zeros(L*L,1);
x0=cat(1,x,y,k,a1,a22);

space=0.01;
tspan=[0,5000];
tic;
[t,x]=ode45(@fun,tspan(1):space:tspan(2),x0);
toc;

figure;
hold on;
    for i=1:10
        plot(t,x(:,3+L*3+1+i));
    end
hold off;

figure;
hold on;
    for i=1:L*L
        plot(t,x(:,3+L*3+1+i+L));
    end
hold off;
 
figure;
Ep1=0;
for i=2
    for j=1:L
        Ep1=Ep1+abs(x(:,3+L*3+1+L*(i-1)-L+j)-A1(i,j));
    end
end
Ep1=Ep1/(L);
plot(t,Ep1);

figure;
Ep2=0;
for i=1:10
    for j=1:10
        Ep2=Ep2+abs(x(:,3+L*3+1+L+L*i-L+j)-A2_2(i,j));
    end
end
Ep2=Ep2/(L*L);
plot(t,Ep2);


function dx=fun(t,x)
    global A1 A2_1 A2_2 m1 m2 d theta o1 o2 L;
    X=x(1:3*L);
    Y(4:6,1)=x(3*L+1:3*L+3);
    k2=x(3*L+3+1);
    a1=x(3*L+2+3:3*L+3+1+L);
    a22=x(3*L+3+1+L+1:3*L+3+1+L+L*L);
    e=Y(4:6)-X(4:6);
    dx=zeros(3*L+3+1+L+L*L,1);
    %驱动层
    for i=1:L
        fi=[(25*theta+10)*(X(3*i-1)-X(3*i-2));(28-35*theta)*X(3*i-2)-X(3*i-2)*X(3*i)+(29*theta-1)*X(3*i-1);X(3*i-2)*X(3*i-1)-1/3*(theta+8)*X(3*i)];
        result=0;
        result1=0;
        for j=1:L
            result=result+o1*A1(i,j)*[X(3*j-2);0;0];
            for k=1:L
                if(i==2)
                    result1=result1+o2*A2_2(j,k)*[X(3*j-2)^2*X(3*k-2);0;0];
                elseif(j==2)
                    result1=result1+o2*A2_2(i,k)*([X(3*i-2)^2*X(3*k-2);0;0]-[X(3*i-2)^2*X(3*i-2);0;0]);
                elseif(k==2)
                    result1=result1+o2*A2_2(j,i)*([X(3*j-2)^2*X(3*i-2);0;0]-[X(3*i-2)^2*X(3*i-2);0;0]);
                end
            end   
        end
        dx(3*i-2:3*i)=fi+result+result1;%1:102
    end
    %响应层
    for i=2
        fi=[(25*theta+10)*(Y(3*i-1)-Y(3*i-2));(28-35*theta)*Y(3*i-2)-Y(3*i-2)*Y(3*i)+(29*theta-1)*Y(3*i-1);Y(3*i-2)*Y(3*i-1)-1/3*(theta+8)*Y(3*i)];
        result=0;
        result1=0;
        for j=1:L
            if(j==2)
            result=result+o1*a1(L*(i-1)+j-L)*[Y(3*j-2);0;0];
            for k=1:L
                if(k==2)
                    result1=result1+o2*a22(L*j+k-L)*[Y(3*j-2)^2*Y(3*k-2);0;0];
                else
                    result1=result1+o2*a22(L*j+k-L)*[Y(3*j-2)^2*X(3*k-2);0;0]; 
                end
            end
            else
            result=result+o1*a1(L*(i-1)+j-L)*[X(3*j-2);0;0];
            for k=1:L
                if(k==2)
                    result1=result1+o2*a22(L*j+k-L)*[X(3*j-2)^2*Y(3*k-2);0;0];
                else
                    result1=result1+o2*a22(L*j+k-L)*[X(3*j-2)^2*X(3*k-2);0;0]; 
                end
            end
            end
        end
        dx(3*(i-1)-2+L*3:3*(i-1)+L*3)=fi+result+result1-k2(i-1)*(e(3*i-3-2:3*i-3));%103:108
     end
     %k值
     for i=1
     dx(3+L*3+1)=d*(e(3*i-2:3*i))'*(e(3*i-2:3*i));%109:110
     end

     for i=1
        for j=1:L
            if(j==2)
            dx(3+L*3+1+j)=-m1*(e(3*i-2:3*i))'*[Y(3*j-2);0;0];
            else
            dx(3+L*3+1+j)=-m1*(e(3*i-2:3*i))'*[X(3*j-2);0;0];
            end
        end
     end

    for i=1
        for j=1:L
            if (j==2)
            for k=1:L
                if (k==2)
                dx(3+L*3+1+L+L*j-L+k)=-m2*(e(3*i-2:3*i))'*[Y(3*j-2)^2*Y(3*k-2);0;0];
                else
                dx(3+L*3+1+L+L*j-L+k)=-m2*(e(3*i-2:3*i))'*[Y(3*j-2)^2*X(3*k-2);0;0];
                end
            end
            else
            for k=1:L
                if(k==2)
                dx(3+L*3+1+L+L*j-L+k)=-m2*(e(3*i-2:3*i))'*[X(3*j-2)^2*Y(3*k-2);0;0];
                else
                dx(3+L*3+1+L+L*j-L+k)=-m2*(e(3*i-2:3*i))'*[X(3*j-2)^2*X(3*k-2);0;0];
                end
            end
            end
        end
    end
end


